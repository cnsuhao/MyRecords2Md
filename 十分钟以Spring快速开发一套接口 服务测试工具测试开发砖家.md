---
title: 十分钟以Spring快速开发一套接口 服务测试工具
date: 2017-11-05 15:43:07
categories: "开发"
tags:
	- Java虚拟机
	- NoSQL
	- Arc
	- 软件
	- JSON

---

> **写在前面：**这是一篇直接使用文字描述的干货，是需要你的10分钟耐心的。

# 场景描述 #

我们平时在开发业务的过程中，测试的重要性不言而喻，通常我们有以下几种情况：  


 *  写了一个单一功能的类，使用单元测试，复杂度：★☆☆☆☆
 *  写了一个业务功能在service中或者DAO中，使用Spring Test框架+JUnit/TestNG，复杂度：★★☆☆☆
 *  写了一个service，并且写了controller api，又写完了DAO，使用Tomcat/Jetty本地测试，复杂度：★★★☆☆
 *  测试通过了部署到了服务器上，发现了问题，除了看日志，对复杂的问题，需要使用JDPA远程调试，复杂度：★★★★☆

下面我们就来说说，如何应对上面第四种做法。  


# 快速构建接口/服务测试 #

服务布上去之后，Controller该怎么写还得怎么写，service也是一样的，包括DAO，为了排除故障，我们想了很多办法，但是，最主要的是，调用很不方便，我们需要先启动服务，然后去APP上点，然后才能看到服务器上的效果，要命的是，某些接口是有操作流程的，如果前面的步骤不能完成，后面的操作是进不去的。

假设：以今日头条APP为例，你想测试查询粉丝数量这个接口，要先点右沿的【我的】这个页面，再进去查看粉丝数量，这个时候才能调用你想要验证的接口，在这个过程中，你要确认APP的版本，有没有因为需求变化对你的接口调用有改变，你还需要一台测试机，等等之类的，总之，比较麻烦，很麻烦，效率堪忧。

这个时候有人说了，那还不简单，我们用PostMan或者ARC不就可以了，照我的经验，这个做法完全不靠谱，**通常情况下，做接口/服务的调用测试，PostMan和ARC都是不能用的**。原因是什么呢？那是因为绝大多数的APP，接口上都是有签名验证的，举个栗子：接口中的参数是一个JSON，这个时候，再配一个公钥，然后RSA加密一下，再使用Key执行一次DES，然后上传了一个String上来了，Controller现在要使用DES解开它，再使用私解解密，再把关键参数验证一下是否为空啥的，参数正常了，再继续执行下面的流程（当然了，这个过程中通常是可以配置在Interceptor中去的），更要命的是，所有接口的操作，必须先正确的登录，登录成功之后再请求接口的时候，你要带上token。。。不管怎么说，**除了在APP上用手点，其他的工具都是不靠谱的**。

那么，我们就没办法了吗？当然不是的，一般情况下，像前面说的参数验签这样的操作，肯定是个公共方法，原因很简单，那么多的接口，我们在每个接口中维护一套验签的代码？当然是不可能的，所以，办法就来了。

我们新建一个Maven工程，然后引入公共的参数签名验证模块，这个时候，再把参数请求的JSON对象所在模块引进来，然后按照下面的步骤开干：

1.  new一个参数类型对象，实例化出来，填入参数
2.  加入签名验证，生成参数加密串
3.  使用HttpClient，填上自己的接口地址，然后发HTTP请求，至于是POST还是GET，就看你的业务需求了
4.  直接去自己的服务器上验证调用结果，这时你已经绕过了所有的前置步骤直接调用的你的接口  
    

说了半天，好像还是没有Spring什么事？不是的。

你在前面测试用的Maven工程中，引入Spring框架，然后创建applicationContext.xml，在里面创建一个开发环境的bean，再创建一个测试环境的bean，再创建一个生产环境的bean（注意此时你要使用@Resource而不是@Autowired，原因不是文本的重点，去搜一下吧），不同的环境有不同的配置文件，分别放到properties中加载引用（比如数据库JDBC地址以及用户名和密码、Redis地址等等之类的），现在好了，你在测试类中注入的是哪个bean，你调用的就是哪个环境的接口。多方便！！！

# 功能扩展 #

仅仅上面说的这个做法，称之为一个工具，似乎low的上不了台面，但它有一个巨大的好处，就是你可以把调用的过程中的参数，直接输出到文件中，测试的过程中，可以下断言，只要测试通过了，你就把请求参数输出到另外一个地方中，当请求的参数足够多的时候，可以直接拿来做性能测试，因为你的数据已经准备好了。

下面梳理一下我当时的具体做法，分享给大家：

1.  按照上面的做法，在测试工程中写测试类，调用接口， 我用的是TestNG而不是JUnit，原因是TestNG可以使用配置文件扩展更多的东西，使用起来超级方便，还可以并发调用，可以和很多变态的需求正面刚。
2.  在测试用例中，对测试结果下断言，通过的情况下，直接将请求数据和响应数据保存到csv文件中。
3.  测试过多个接口并多次的情况下，我的接口的数据就准备好了，这些接口请求数据中，是带了token的，输出的参数也是RSA和DES处理过的，所以可以直接拿来用，那么怎么用呢？继续往下看。
4.  启动JMeter，创建用例，线程组，取样器，然后使用函数助手把前面请求的参数加载进来，这里的测试可以灵活指定的，你可以重复使用一个参数，也可以循环读取一个文件，还可以随机再生成一些其他参数拼上，总之，既足灵活和强大，又足够简单。

现在，这一整套东西，就可以初步的称之为一个接口/服务测试工具了，在这个基础上，我们做一些细节，好好完善完善它，比如某些接口调用的时候需要传验证码，那么我们可以直接去Redis中取出来，然后验证接口上的是不是预期值。  


# 写在最后 #

最后再啰嗦几句，无论是TestNG还是JMeter，都是基于Java也就是JVM的，当请求量很大并且参数的数据量很大的时候，会出现问题，我测试的情况是：请求3个接口，每个接口并发1000，循环100次，每个接口的参数大概是请求1024个字符响应512个字符，这种情况下，它们所在的JVM进程必定无响应，即使我把JVM的参数xms、xmx啥的，调到让它使用我的全部32GB内存也无济于事，因为数据量实在太大了，而这个时候，我预期要测试的接口性能的TPS强度还不到500，真是太让我郁闷了。那么，，，我们就没有办法了吗？当然不是的！！！

**杀招：：：**

JMeter是支持分布式部署和执行测试用例的，但是我们通常要面对更加现实的问题：写用例、部署用例、执行用例再拿到结果，这个漫长的过程是不能忍的，而且公司也未必有那么多的服务器资源可以让我们挥霍。所以，我最近正在开发一个基于Golang的接口测试工具，目前的时间服务器的基准测试是，TPS可以压到1.5万，带再上一些业务逻辑，7000是没问题的，目前来看足以**碾压JMeter**。整个项目完成之后我会在Github上发布开源出来，请大家关注我，谢谢。

![十分钟以Spring快速开发一套接口/服务测试工具][Spring]


[Spring]: /pro/os/crawler/QIEE-AFB3-MER3.jpg
 *  **原文作者：** 测试开发砖家
 *  **原文链接：** https://www.toutiao.com/item/6484829644620038670/
 *  **版权声明：** 本博客所有文章除特别声明外，均采用 [CC BY-NC-SA 4.0][] 许可协议。转载请注明出处。