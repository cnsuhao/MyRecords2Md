---
title: 只会搭建Redis集群怎么能hold得住月薪20K?来看原理！
date: 2018-01-29 22:38:21
categories: "开发"
tags:
	- NoSQL
	- 技术
	- 通信
	- Redis

---

上一篇介绍了如何搭建Redis集群，不知大家有没有按照文章提示一步一步把集群搭建起来。搭建过程中必然会遇到很多问题，但是只有遇到问题，才会促使自己去思考发生问题的原因，认真总结，避免下一次踩到坑！上一篇介绍操作，这一篇介绍原理，下面言归正传

# 数据分布理论 #

> 分布式数据库首先要解决**把整个数据集按照分区规则映射到多个节点**的问题，即把**数据集划分到多个节点上，每个节点负责整体数据的一个子集**
> 
> ![只会搭建Redis集群怎么能hold得住月薪20K?来看原理！][Redis_hold_20K]

# Redis采用虚拟槽分区 #

> 虚拟槽分区巧妙地使用了**哈希空间**，使用**分散度良好的哈希函数**把所有数据映射到一个固定范围的整数集合中，整数定义为槽（slot）。这个范围一般远远大于节点数，比如Redis Cluster槽范围是0~16383。**槽是集群内数据管理和迁移的基本单位**。采用大范围槽的主要目的是为了方便**数据拆分**和**集群扩展**。每个节点会负责一定数量的槽。

# Redis数据分区 #

> Redis Cluser采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整数槽内，计算公式：slot=CRC16（key）&16383，每一个节点负责维护一部分槽以及槽所映射的键值数据

![只会搭建Redis集群怎么能hold得住月薪20K?来看原理！][Redis_hold_20K 1]

![只会搭建Redis集群怎么能hold得住月薪20K?来看原理！][Redis_hold_20K 2]

# Redis虚拟槽分区的优点 #

1.  解耦数据和节点之间的关系，简化了节点扩容和收缩难度
2.  节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据
3.  支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景

# Redis集群功能的限制 #

1.  只有在一个槽内才支持批量操作。如mset、mget，目前只支持具有相同slot值的key执行批量操作。对于映射为不同slot值的key由于执行mget、mget等操作可能存在于多个节点上因此不被支持。
2.  只有在一个节点上的key才支持事务，当多个key分布在不同的节点上时无法使用事务功能
3.  不能将hash、list等较大的键值对象映射到不同的节点
4.  集群模式下只能使用一个数据库空间，即db0
5.  复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构

# 节点握手 #

节点握手是指**一批运行在集群模式下的节点通过Gossip协议彼此通信，达到感知对方的过程**。节点握手是集群彼此通信的第一步，由客户端发起命令：cluster meet \{ip\} \{port\}

![只会搭建Redis集群怎么能hold得住月薪20K?来看原理！][Redis_hold_20K 3]

图中执行的命令是：cluster meet 127.0.0.1 6380 让节点6379和6380节点进行握手通信。cluster meet命令是一个异步命令，执行之后立刻返回。内部发起与目标节点进行握手通信，过程如下:

1.  节点6379本地创建6380节点信息对象，并发送meet消息
2.  节点6380接受到meet消息后，保存6379节点信息并回复pong消息
3.  之后节点6379和6380彼此定期通过ping/pong消息进行正常的节点通信
    

![只会搭建Redis集群怎么能hold得住月薪20K?来看原理！][Redis_hold_20K 4]

集群内任意节点上执行cluster meet命令加入新节点，握手状态会通过消息在集群内传播，这样其他节点会自动发现新节点并发起握手。

# 分配槽 #

redis集群把所有的数据映射到16384个槽中。每个key会映射为一个固定的槽，只有当节点分配了槽，才能响应和这些槽关联的键命令

# 总结 #

今天就先写这么多，都是一些概念性的东西，需要理解并牢记。下一篇介绍节点通信、集群伸缩。



[Redis_hold_20K]: /pro/os/crawler/MEFZ-RBYE-6VNF.jpg
[Redis_hold_20K 1]: /pro/os/crawler/Q36F-M33Y-UFZZ.jpg
[Redis_hold_20K 2]: /pro/os/crawler/RJJU-UBRN-QRNU.jpg
[Redis_hold_20K 3]: /pro/os/crawler/63IY-INMA-BNZR.jpg
[Redis_hold_20K 4]: /pro/os/crawler/AMFR-UVYE-IJ7B.jpg
 *  **原文作者：** Java修炼手册
 *  **原文链接：** https://www.toutiao.com/item/6516480569151324675/
 *  **版权声明：** 本博客所有文章除特别声明外，均采用 [CC BY-NC-SA 4.0][] 许可协议。转载请注明出处。